name: Schema Sync Check

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'prisma/schema.prisma'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'prisma/schema.prisma'

jobs:
  schema-sync:
    runs-on: ubuntu-latest
    name: Verify Prisma schema matches main backend

    steps:
      - name: Checkout chat backend
        uses: actions/checkout@v4
        with:
          path: chat-backend

      - name: Checkout main SELVE backend
        uses: actions/checkout@v4
        with:
          repository: selve-org/selve
          path: main-backend
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check schema sync
        run: |
          echo "üîç Checking schema sync between repos..."
          
          CHAT_SCHEMA="chat-backend/prisma/schema.prisma"
          MAIN_SCHEMA="main-backend/backend/schema.prisma"
          
          if [ ! -f "$CHAT_SCHEMA" ]; then
            echo "‚ùå Chat backend schema not found at $CHAT_SCHEMA"
            exit 1
          fi
          
          if [ ! -f "$MAIN_SCHEMA" ]; then
            echo "‚ùå Main backend schema not found at $MAIN_SCHEMA"
            exit 1
          fi
          
          if diff -q "$CHAT_SCHEMA" "$MAIN_SCHEMA" > /dev/null 2>&1; then
            echo "‚úÖ Schemas are in sync!"
            exit 0
          else
            echo "‚ùå SCHEMA MISMATCH!"
            echo ""
            echo "Differences:"
            diff "$CHAT_SCHEMA" "$MAIN_SCHEMA" || true
            echo ""
            echo "‚ö†Ô∏è  Both backends must use the same schema."
            echo "üí° Update the chat backend schema to match the main backend."
            exit 1
          fi
        shell: bash
